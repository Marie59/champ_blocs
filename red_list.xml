<tool id="srs_red_list" name="Red List Index" version="@VERSION@" profile = "20.01">
    <description>from  remote sensing data</description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <expand macro="SRS_requirements">
        <requirement type="package" version="1.0.3">r-redlistr</requirement>
        <requirement type="package" version="3.3.6">r-ggplot2</requirement>
        <requirement type="package" version="1.1.1">r-cowplot</requirement>
        <requirement type="package" version="2.3">r-gridextra</requirement>
    </expand>
    <command detect_errors="exit_code"><![CDATA[ 
        #import re 
        #if $mode.type_data.origin == 'envi_bil':
          #set input_raster_1 = $mode.type_data.input_raster_1
          #set input_raster_1_identifier = re.sub('[^\s\w\-]', '_', str($input_raster_1.element_identifier)) 
          #set input_header_1 = $mode.type_data.input_header_1
          #set input_header_1_identifier = re.sub('[^\s\w\-]+[^.hdr]', '_', str($input_header_1.element_identifier))
          ln '${input_raster_1}' '${input_raster_1_identifier}' &&
          ln '${input_header_1}' '${input_header_1_identifier}' && 
        #end if
        #if $mode.criteria == 'A' and $mode.type_data.origin == 'envi_bil':
          #set input_raster_2 = $mode.type_data.input_raster_2
          #set input_raster_2_identifier = re.sub('[^\s\w\-]', '_', str($input_raster_2.element_identifier)) 
          #set input_header_2 = $mode.type_data.input_header_2
          #set input_header_2_identifier = re.sub('[^\s\w\-]+[^.hdr]', '_', str($input_header_2.element_identifier)) 
          ln '${input_raster_2}' '${input_raster_2_identifier}' &&
          ln '${input_header_2}' '${input_header_2_identifier}' &&
        #end if 
        Rscript
            '$__tool_directory__/red_list.r'
            '$__tool_directory__/functions.r'
            '$redlist'
            #if $mode.criteria == 'A' and $mode.type_data.origin == 'envi_bil':
              '$input_raster_1_identifier' 
              '$input_header_1_identifier'
              '$input_raster_2_identifier' 
              '$input_header_2_identifier'
              ''
              ''
              ''
              ''
            #else if $mode.criteria == 'A' and $mode.type_data.origin == 'zipper':
              ''
              ''
              ''
              ''
              '$mode.type_data.input1'
              '$mode.type_data.input2'
              ''
              ''
            #else if $mode.criteria == 'A' and $mode.type_data.origin == 'raster':
              '' 
              ''
              '' 
              ''
              ''
              ''
              'input_raster1'
              'input_raster2'
            #else if $mode.criteria == 'B' and $mode.type_data.origin == 'envi_bil':
              '$input_raster_1_identifier' 
              '$input_header_1_identifier'
              ''
              ''
              ''
              ''
              ''
              ''
            #else if $mode.criteria == 'B' and $mode.type_data.origin == 'zipper':
              ''
              ''
              ''
              ''
              '$mode.type_data.input1'
              ''
              ''
              ''
            #else if $mode.criteria == 'B' and $mode.type_data.origin == 'raster':
              '' 
              ''
              ''
              ''
              ''
              ''
              'input_raster1'
              ''
            #end if
            '$output_rli'
            '$plots'
        ]]>
    </command>
    <inputs>
        <param name="redlist" type="select" label="Which kind of red list assesment do you want to do ?" display="radio">
            <option value="RLE">Red List Ecosystem</option>
            <option value="RLS">Red List Species</option>
        </param>
        <conditional name="mode">
            <param name="criteria" type="select" label="Which one of those criteria do you want to compute ?" display="radio" help="Criterion A temporal assesment and B spatial assesment">
                <option value="A">Criterion A</option>
                <option value="B">Criterion B</option>
            </param>
            <when value="A">
                <conditional name="type_data">
                    <param name="origin" type="select" label="In which format are your data ?">
                        <option value="zipper">The data you are using are in a zip folder Reflectance</option>
                        <option value="envi_bil">Your already have the files in ENVI BIL format</option>
                        <option value="raster">You have your data in a raster format : tif, ...</option>
                    </param>
                    <when value="zipper">
                        <param name="input1" type="data" format="zip" multiple="true" label="Input data 1"/>
                        <param name="input2" type="data" format="zip" multiple="true" label="Input data 2"/>
                    </when>
                    <when value="envi_bil">
                        <param name="input_raster_1" type="data" format="bil" label="Input raster 1"/>
                        <param name="input_header_1" type="data" format="hdr" label="Input header 1"/>
                        <param name="input_raster_2" type="data" format="bil" label="Input raster 2"/>
                        <param name="input_header_2" type="data" format="hdr" label="Input header 2"/>
                    </when>
                    <when value="raster">
                        <param name="input1" type="data" format="data" label="Input data 1"/>
                        <param name="input2" type="data" format="data" label="Input data 2"/>
                    </when>
                </conditional>
            </when>
            <when value="B">
                <conditional name="type_data">
                    <param name="origin" type="select" label="In which format are your data ?">
                        <option value="zipper">The data you are using are in a zip folder Reflectance</option>
                        <option value="envi_bil">Your already have the files in ENVI BIL format</option>
                        <option value="raster">You have your data in a raster format : tif, ...</option>
                    </param>
                    <when value="zipper">
                        <param name="input1" type="data" format="zip" multiple="true" label="Input data 1"/>
                    </when>
                    <when value="envi_bil">
                        <param name="input_raster_1" type="data" format="bil" label="Input raster 1"/>
                        <param name="input_header_1" type="data" format="hdr" label="Input header 1"/>
                    </when>
                    <when value="raster">
                        <param name="input1" type="data" format="data" label="Input data 1"/>
                    </when>
                </conditional>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="output_rli" from_work_dir="repport.txt" format="txt" label="Red list criterion ${mode.criteria}"/>
        <collection type="list" name="plots" label="Criterion ${mode.criteria} plot">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.png" visible="false" format="png"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="origin" value="envi_bil"/>
            <param name="input_raster" value="S2A_Subset"/>
            <param name="input_header" value="S2A_Subset.hdr"/>
            <param name="type" value="all"/>
            <output name="output_rli">
                <assert_contents>
                    <has_n_columns n="3"/>
                </assert_contents>
            </output>
            <output_collection name="plots" type="list" count="3"/>
        </test>
    </tests>
    <help><![CDATA[
========================================================================
Calculate cloud mask from envi bil format
========================================================================


**What it does**



**Input description**

It expects an image file as input, with a specific data format. ENVI HDR image with BIL interleave required.
The image is an ENVI raster including :

- A binary file (which has no extension here).

- A header file (with .hdr extension).

The header file is a text file including all necessary metadata which can be read with a text editor. It includes image dimensions, projection, and the name and central wavelength for each spectral band.

In order to get such input we advise to use the tool preprocessing sentinel 2 data. 

+--------------+----------+
|      BIL     | ENVI HDR |
+==============+==========+
| raster stack | Metadata |
+--------------+----------+
|      ...     |    ...   |
+--------------+----------+

**Output**



    ]]>    </help>
        <expand macro="SRS_BDMRref"/>
</tool>
